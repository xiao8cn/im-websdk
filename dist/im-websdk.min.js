!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.IM=t():e.IM=t()}(this,function(){return function(e){function t(o){if(n[o])return n[o].exports;var s=n[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="./",t(t.s=1)}([function(e,t,n){"use strict";function o(e){try{for(var t=btoa(encodeURIComponent(JSON.stringify(e))),n=t.split(""),o=[],s=0,r=n;s<r.length;s++){var c=r[s];o.push(c.charCodeAt(0))}return new Uint8Array(o)}catch(e){return console.log("msgToUint err"+e),new Uint8Array([])}}function s(e){try{var t=String.fromCharCode.apply(null,new Uint8Array(e)),n=decodeURIComponent(atob(t));return JSON.parse(n)}catch(e){return console.log("uintToMsg err"+e),{}}}function r(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}t.b=o,t.c=s,t.a=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(2),s=n(0),r=function(){function e(e){this.callbacks={},this.timeout=20,this.canRequest=!1,this.reqNo=Math.random().toString(16).substring(2)+"_"+Date.now(),this.SEND_MESSAGE_CMD="send_message",this.SEND_GROUP_MESSAGE_CMD="send_message_multi",this.GET_OFFLINE_MESSAGE_CMD="send_message_offline",this.RECEIPT_MESSAGE_CMD="send_message_receipt",this.initTimeoutTicker(),e.onMessage&&(this.onMessage=e.onMessage),e.onConnected&&(this.onConnected=e.onConnected),e.onClosed&&(this.onClosed=e.onClosed),e.onError&&(this.onError=e.onError)}return e.prototype.connectWSServer=function(e,t){var n=this;this.ws=new o.a(e,null,{binaryType:"arraybuffer",debug:!1,reconnectInterval:4e3,timeoutInterval:5e3}),this.ws.onOpen=function(e){n.canRequest=!0,t&&t(null,e),n.onConnected(e)},this.ws.onClose=function(e){n.canRequest=!1,n.onClosed(e)},this.ws.onMessage=function(e){var t=Object(s.c)(e.data);n.callbacks[t.cmd]&&n.callbacks[t.cmd][t.resNo]?(n.callbacks[t.cmd][t.resNo](null,t),delete n.callbacks[t.cmd][t.resNo]):n.onMessage(t)},this.ws.onError=function(e){n.onError(e)},window.onbeforeunload=function(){n.ws.close()},window.onunload=function(){n.ws.close()}},e.prototype.request=function(e,t,n){this.canRequest&&("function"==typeof n&&(n.deadline=Date.now()+1e4,this.callbacks[e]||(this.callbacks[e]={}),this.callbacks[e][this.reqNo]=n),this.send(e,this.reqNo,t))},e.prototype.send=function(e,t,n){var o={cmd:e,reqNo:t,params:n};this.ws.send(Object(s.b)(o))},e.prototype.sendMessage=function(e,t){this.request(this.SEND_MESSAGE_CMD,e,t)},e.prototype.sendGroupMessage=function(e,t){this.request(this.SEND_GROUP_MESSAGE_CMD,e,t)},e.prototype.getOfflineMessage=function(e,t){this.request(this.GET_OFFLINE_MESSAGE_CMD,e,t)},e.prototype.receipt=function(e,t){this.request(this.RECEIPT_MESSAGE_CMD,e,t)},e.prototype.closeConnection=function(){this.ws.close()},e.prototype.close=function(){this.ws.close()},e.prototype.initTimeoutTicker=function(){var e=this;setInterval(function(){for(var t=Date.now(),n=0,o=Object.keys(e.callbacks);n<o.length;n++)for(var s=o[n],r=e.callbacks[s],c=0,i=Object.keys(r);c<i.length;c++){var a=i[c],u=r[a];t>u.deadline&&(u(null,{data:{code:"0",msg:"请求超时",status:!1}}),delete e.callbacks[s][a])}},1e3*this.timeout)},e}();t.default=r},function(e,t,n){"use strict";var o=n(0),s={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"},r=function(){function e(e,t,n){this.reconnectAttempts=0,this.url=e,this.initSettings(n),this.readyState=WebSocket.CONNECTING,this.protocol="",this.protocols=t,this.eventTarget=document.createElement("div"),this.addSocketListener(),this.addEventListener=this.eventTarget.addEventListener.bind(this.eventTarget),this.removeEventListener=this.eventTarget.removeEventListener.bind(this.eventTarget),this.dispatchEvent=this.eventTarget.dispatchEvent.bind(this.eventTarget),!0===s.automaticOpen&&this.open(!1),this.debugAll=!1,this.CONNECTING=WebSocket.CONNECTING,this.OPEN=WebSocket.OPEN,this.CLOSING=WebSocket.CLOSING,this.CLOSED=WebSocket.CLOSED}return e.prototype.initSettings=function(e){for(var t=0,n=Object.keys(e);t<n.length;t++){var o=n[t];void 0!==e[o]?this[o]=e[o]:this[o]=s[o]}},e.prototype.open=function(e){var t=this;if(!("WebSocket"in window))throw new Error("WebSocket not supported by current browser!");if(this.ws=new WebSocket(this.url,this.protocols||[]),this.ws.binaryType=this.binaryType,e){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else this.eventTarget.dispatchEvent(Object(o.a)("connecting")),this.reconnectAttempts=0;(this.debug||this.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",this.url);var n=this.ws,r=setTimeout(function(){(t.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",t.url),t.timedOut=!0,n.close(),t.timedOut=!1},s.timeoutInterval);this.ws.onopen=function(){clearTimeout(r),(t.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","onopen",t.url),t.protocol=t.ws.protocol,t.readyState=WebSocket.OPEN,t.reconnectAttempts=0;var n=Object(o.a)("open");Object.assign(n,{isReconnect:e}),e=!1,t.eventTarget.dispatchEvent(n)},this.ws.onclose=function(n){if(clearTimeout(r),t.ws=null,t.forcedClose)t.readyState=WebSocket.CLOSED,t.eventTarget.dispatchEvent(Object(o.a)("close"));else{t.readyState=WebSocket.CONNECTING;var c=Object(o.a)("connecting");Object.assign(c,{code:n.code,reason:n.reason,wasClean:n.wasClean}),t.eventTarget.dispatchEvent(c),e||t.timedOut||((t.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","onclose",t.url),t.eventTarget.dispatchEvent(Object(o.a)("close")));var i=s.reconnectInterval*Math.pow(s.reconnectDecay,t.reconnectAttempts);setTimeout(function(){t.reconnectAttempts++,t.open(!0)},i>s.maxReconnectInterval?s.maxReconnectInterval:i)}},this.ws.onmessage=function(e){(t.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",t.url,e.data);var n=Object(o.a)("message");Object.assign(n,{data:e.data}),t.eventTarget.dispatchEvent(n)},this.ws.onerror=function(e){(t.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","onerror",t.url,e),t.eventTarget.dispatchEvent(Object(o.a)("error"))}},e.prototype.addSocketListener=function(){var e=this;this.eventTarget.addEventListener("open",function(t){e.onOpen(t)}),this.eventTarget.addEventListener("close",function(t){e.onClose(t)}),this.eventTarget.addEventListener("connecting",function(t){e.onConnecting(t)}),this.eventTarget.addEventListener("message",function(t){e.onMessage(t)}),this.eventTarget.addEventListener("error",function(t){e.onError(t)})},e.prototype.send=function(e){if(this.ws)return(this.debug||this.debugAll)&&console.debug("ReconnectingWebSocket","send",this.url,e),this.ws.send(e);throw new Error("INVALID_STATE_ERR : Pausing to reconnect websocket")},e.prototype.close=function(e,t){void 0===e&&(e=1e3),this.forcedClose=!0,this.ws&&this.ws.close(e,t)},e.prototype.refresh=function(){this.ws&&this.ws.close()},e.prototype.onOpen=function(e){},e.prototype.onClose=function(e){},e.prototype.onConnecting=function(e){},e.prototype.onMessage=function(e){},e.prototype.onError=function(e){},e}();t.a=r}])});